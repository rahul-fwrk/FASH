import { Component ,Injectable} from '@angular/core';
import { NavController, Nav } from 'ionic-angular';
import { CardswipePage } from '../cardswipe/cardswipe';
import { ProductdetailsPage } from '../productdetails/productdetails';
import { SigninPage } from '../signin/signin';
import { TabsPage } from '../tabs/tabs';
import { Http, Headers, RequestOptions } from '@angular/http';
import { LoadingController, AlertController } from 'ionic-angular';
import { ToastController } from 'ionic-angular';
import { MediaPlugin } from 'ionic-native';

import { Appsetting } from '../../providers/appsetting';
import 'rxjs/add/operator/map';
import { Events } from 'ionic-angular';
import { InAppBrowser } from '@ionic-native/in-app-browser';
import { NativeAudio } from '@ionic-native/native-audio';
import { Media, MediaObject } from '@ionic-native/media';
import {Subject} from "rxjs/Subject";
import {Observable} from "rxjs/Rx";

@Component({
  selector: 'page-myfavorites',
  templateUrl: 'myfavorites.html'
})
@Injectable()
export class MyfavoritesPage {
  allProducts; audio;file;
  tracks: any = [];
  playing: boolean = true;
  currentTrack: any;
  audioIndex;
  constructor(
    public navCtrl: NavController,
    public http: Http,
    public loadingCtrl: LoadingController,
    public alertCtrl: AlertController,
    public appsetting: Appsetting,
    public toastCtrl: ToastController,
    public events: Events,
    public nav: Nav,
    public inappBrowser: InAppBrowser,
    private nativeAudio: NativeAudio,
    public media: Media
  ) {
    alert('update alert');
    events.subscribe('page', (myFav) => {
      console.log(myFav);
      this.myFavs();
    })
  }
 protected resumeHalted = false;
    protected resumeSubject = new Subject<any>();
  /************ function for play audio ********/
  playAgain(trackall,index){
    this.audioIndex=index;
    
    if(trackall[index].playing){
      this.currentTrack=this.tracks[index];
    const file: MediaObject = this.media.create(trackall[index].url);
    var len=trackall.length;
    file.play();
    file.onSuccess.subscribe(() => {
    //   alert('Action is successful');
    //const file: MediaObject = this.media.create(trackall[index+1].url);
    index++;
    if(index<len && trackall[index-1].playing==true){
      trackall[index-1].playing=false;
      trackall[index].playing=true;
      this.playAgain(trackall,index);
      }
    },err=>{
      alert('next unsuccessful');
    }) }
  }

  playTrack() {
    alert("clicked");
    var i = 0;
    this.audioIndex=0;
    this.currentTrack=this.tracks[0];
    // for(var i = 0;i<this.tracks.length;){
      var len=this.tracks.length;
      this.tracks[i].playing=true;

    const file: MediaObject = this.media.create(this.tracks[i].url);
    alert('starts')
    file.play();
    file.onSuccess.subscribe(() => {
    //   alert('Action is successful');
      this.audioIndex=1;
      
    //const file: MediaObject = this.media.create(this.tracks[i+1].url);
    i++;
    if(i<len && this.tracks[i-1].playing==true){
      this.tracks[i-1].playing=false;
      this.tracks[i].playing=true;
      this.playAgain(this.tracks,i);
      }
    },err=>{
      alert('next unsuccessful');
    })
  
    file.onStatusUpdate.subscribe(status => {
      alert(i);
     if(status == 4){
       alert("4status4")
    //    const file: MediaObject = this.media.create(this.tracks[i+1].url);
    // file.play();
     }
      alert('status'+status)
    });

    //}

  }

  nexttrack() {
    alert("nextTrack");
    // const file: MediaObject = this.media.create(this.tracks[this.audioIndex-1].url);
     this.audioIndex=this.audioIndex+1;
     if(this.audioIndex>0){
       const file: MediaObject = this.media.create(this.tracks[this.audioIndex-1].url);
       file.play();
       this.file.pause();
       this.file.stop();
       //this.isPlaying=false;
       //file.release();
       alert("yu");
    }
    // file.stop();
    // file.release();
    // const file: MediaObject = this.media.create(this.tracks[this.audioIndex].url);
    // alert('nextplay')
    // var len=this.tracks.length;
    // file.play();
    //   file.onStatusUpdate.subscribe(status => {
    //    alert(status+' is successful');
    // if(status==4){
    //   alert(this.audioIndex+"rahul");
    //   this.audioIndex=1;
    // const file: MediaObject = this.media.create(this.tracks[this.audioIndex+1].url);
    // this.audioIndex++;
    // if(this.audioIndex<len){
    //     alert("vikkighuyt");
    //     this.playAgain(this.tracks,this.audioIndex);
    //   alert("hellorahul");
    //   }
    // }

    // },err=>{
    //   alert('next play unsuccessful');
    // })
      alert("not now");
      alert(this.audioIndex);
  }
   nextTrack(){
     var len=this.tracks.length;
    alert(this.audioIndex);     alert("next");
    if(this.audioIndex>=0 && this.audioIndex<=len){
       this.audioIndex=this.audioIndex+1;
      if(this.audioIndex<len && this.tracks[this.audioIndex-1].playing==true){
        for(let checkTrack of this.tracks){
            if(checkTrack.playing){
                this.pauseTrack(checkTrack);
            } 
        }
          this.tracks[this.audioIndex].playing=true;
          this.playAgain(this.tracks,this.audioIndex);
        }
    }else{
      alert("at last song");
    }
   }
   pauseTrack(track){
    track.playing=false;
   }
   prevTrack(){
     alert(this.audioIndex); alert("prev");
     if(this.audioIndex>0){
       this.audioIndex=this.audioIndex-1;
      var len=this.tracks.length;
      if(this.audioIndex<len && this.tracks[this.audioIndex+1].playing==true){
          for(let checkTrack of this.tracks){
            if(checkTrack.playing){
                this.pauseTrack(checkTrack);
            } 
        }
          this.tracks[this.audioIndex].playing=true;
          this.playAgain(this.tracks,this.audioIndex);
        }
    }else{
      alert("at first song");
    }
    
   }

  prevtrack(){
    alert("prevTrack");
    // const file: MediaObject = this.media.create(this.tracks[this.audioIndex-1].url);
     
    // file.stop();
    // file.release();
    if(this.audioIndex>0){
       this.audioIndex=this.audioIndex-1;
       if(this.tracks[this.audioIndex+1].playing==true){
       this.tracks[this.audioIndex+1].playing=false;
       this.tracks[this.audioIndex].playing=true;
      //  const file: MediaObject = this.media.create(this.tracks[this.audioIndex].url);
      //  file.play();
      //  file.stop();
      //  file.release();
       const file: MediaObject = this.media.create(this.tracks[this.audioIndex].url);
      alert('prevplay')
      var len=this.tracks.length;
      alert(len);
      alert(JSON.stringify(this.tracks)); 
      file.play();
      file.onSuccess.subscribe(() => {
    //   alert('Action is successful');
      //alert(this.audioIndex+"prev");
      //this.audioIndex=1;
    //const file: MediaObject = this.media.create(this.tracks[this.audioIndex-1].url);
      
      if(this.audioIndex<len && this.tracks[this.audioIndex-1].playing==true){
        this.audioIndex++;
        alert("prevnowplay");
          this.tracks[this.audioIndex-1].playing=false;
          this.tracks[this.audioIndex].playing=true;
          this.playAgain(this.tracks,this.audioIndex);
        }
      },err=>{
        alert('prev play unsuccessful');
      })
      }
    }
  }

 

  /************ function for spotify login ****************/
  logSpotify() {
    if (!localStorage.getItem('code')) {
      var loginurl = 'https://accounts.spotify.com/authorize/?client_id=d1c1031c1b214739a9ba672e90cd2798&response_type=code&redirect_uri=https://rakesh.crystalbiltech.com&scope=';
      var target = '_self'
      var options = 'location=yes'
      var openspotify = this.inappBrowser.create(loginurl, target, options);
      console.log(loginurl);
      console.log(target);
      console.log(openspotify);
      openspotify.on('loadstart').subscribe((e) => {
        alert(e)
        console.log(e);
        let url = e.url;
        console.log(url);
        var redirect_uri = e.url.split('code=');
        console.log(redirect_uri);
        alert(redirect_uri[0]);
        if (redirect_uri[0] == 'https://rakesh.crystalbiltech.com/?') {
          let code = redirect_uri[1];
          alert('code--->' + code);
          console.log(code);
          localStorage.setItem('code', code);
          openspotify.close();
        }
      }, err => {
        console.log("InAppBrowser loadstart Event Error: " + err);
        alert(err)
      });

      openspotify.on('exit').subscribe((e) => {
        var code = localStorage.getItem('code');
        this.getToken(code);
      })
    } else {
      alert('token found');
      var code = localStorage.getItem('code');
      this.getToken(code);
    }

  }

  /********** function for get token from spotify ***********/
  private getToken(code) {

    alert('you are here ....');
    alert(code)
    var url: "https://accounts.spotify.com/api/token";
    this.http.get(this.appsetting.myGlobalVar + 'cities/spotifytoken').map(res => res.json()).subscribe(data => {
      alert('success');
      alert(JSON.stringify(data));
      this.getplaylist(data.access_token, data.token_type);
      // this.response = data.data;
    },
      err => {
        alert(JSON.stringify(err));
        alert('err' + JSON.stringify(err))
      })

  }

  /******** function for get playlist *****************/

  private getplaylist(token, tokentype) {
    alert(token);
    alert(tokentype);
    var url = "https://api.spotify.com/v1/users/mango_official/playlists/3KE0N6vRrsuPnIg0ciVHU5";
    var data = { 'token': token, 'token_type': tokentype, 'urld': url };
    let headers = new Headers();
    headers.append('Content-Type', 'application/x-www-form-urlencoded;charset=utf-8');
    let options = new RequestOptions({ headers: headers });

    var serialized = this.serializeObj(data);
    this.http.post(this.appsetting.myGlobalVar + 'cities/spotifygetplaylist', serialized, options).map(res => res.json()).subscribe(data => {
      alert('success');
      alert(JSON.stringify(data));

    // this.tracks = data.tracks.items;
      for (var i = 0; i < data.tracks.items.length; i++) {
        if (data.tracks.items[i].track.preview_url != null) {
          this.tracks.push({
            'url': data.tracks.items[i].track.preview_url,
            'playing':false
            //  'title':data.tracks.items[i].track.name,
            //  'artist':data.tracks.items[i].artists[0].name
          });
        }
        //console.log(data.tracks.items[i].artists.length);
      }

      alert(JSON.stringify(this.tracks));
    },
      err => {
        alert(JSON.stringify(err));
        alert('err' + JSON.stringify(err))
      })
  }

  stopaudio() {
    if (this.audio.src) {
      this.audio.pause();
    }
  }



  doRefresh(refresher) {
    console.log('Begin async operation', refresher);
    this.myFavs();
    setTimeout(() => {
      console.log('Async operation has ended');
      refresher.complete();
    }, 2000);
  }

  myFavs() {
    let headers = new Headers();
    headers.append('Content-Type', 'application/x-www-form-urlencoded;charset=utf-8');
    let options = new RequestOptions({ headers: headers });
    var user_id = localStorage.getItem('USERID');
    if (user_id == null || undefined) {
      this.ConfirmUser();
    } else {
      var postdata = {
        userid: user_id,
      };
      console.log(postdata);
      var serialized = this.serializeObj(postdata);

      var Loading = this.loadingCtrl.create({
        content: 'Please wait...'
      });

      this.http.post(this.appsetting.myGlobalVar + 'lookbooks/usersfavourites', serialized, options)
        .map(res => res.json()).subscribe(data => {
          Loading.dismiss();
          console.log(data);
          if (data.status == 0) {
            this.allProducts = data.data;
          } else {
            this.allProducts = null;
            this.showToast('No favorites yet! :(');
          }
          this.events.publish('haveSeen', 'yes');
        })
    }
  }

  ConfirmUser() {
    let alert = this.alertCtrl.create({
      title: 'Fash',
      message: 'Please login to use this feature.',
      buttons: [
        {
          text: 'Cancel',
          role: 'cancel',
          handler: () => {
            console.log('Cancel clicked');
            console.log(localStorage.getItem('USERID'));
            if (localStorage.getItem('USERID') == null) {
              this.navCtrl.push(TabsPage);
            }
          }
        },
        {
          text: 'Login',
          handler: () => {
            this.nav.setRoot(SigninPage);
            this.nav.popToRoot();
          }
        }
      ]
    });
    alert.present();
  }

  showToast(msg) {
    var toast = this.toastCtrl.create({
      message: msg,
      duration: 2500,
      cssClass: 'toastCss',
      position: 'middle',
      // closeButtonText: 'ok'
    });
    toast.present();
  }

  productDetails(i) {
    var id = i;
    console.log(id);
    this.navCtrl.push(ProductdetailsPage, { prod_id: id })
  }

  serializeObj(obj) {
    var result = [];
    for (var property in obj)
      result.push(encodeURIComponent(property) + "=" + encodeURIComponent(obj[property]));

    return result.join("&");
  }

}
